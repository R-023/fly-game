<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fly Game</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 600px;
      margin: 20px auto;
      padding: 0 15px;
      background: #f8f9fa;
      color: #212529;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    .subtitle {
      text-align: center;
      color: #6c757d;
      margin-top: 0;
    }
    .section {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 600;
      color: #495057;
    }
    input, button, select {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      background: #0d6efd;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) {
      background: #0b5ed7;
    }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
      opacity: 0.7;
    }

    /* Grid */
    .grid-container {
      display: grid;
      gap: 2px;
      grid-template-columns: repeat(auto-fit, minmax(64px, 1fr));
      justify-content: center;
      padding: 10px;
      background: #f1f3f5;
      border-radius: 10px;
      max-width: 400px;
      width: 100%;
    }
    .cell {
      width: 100%;
      height: 100%;
      aspect-ratio: 1 / 1; /* —á—Ç–æ–±—ã –±—ã–ª –∫–≤–∞–¥—Ä–∞—Ç */
      max-width: 64px;
      max-height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #e9ecef;
      border: 1px solid #adb5bd;
      border-radius: 8px;
      font-weight: bold;
      font-size: 20px;
      cursor: pointer;
      user-select: none;
      transition: all 0.15s ease;
    }
    .cell:hover {
      background: #dee2e6;
      transform: scale(1.04);
    }
    .cell.start { background: #ffc107; } /* Start ‚Äî yellow */
    .cell.selected { background: #0dcaf0; } /* Player choice ‚Äî blue */
    .cell.correct { background: #198754; color: white; } /* Correct ‚Äî green */
    .cell.incorrect { background: #dc3545; color: white; } /* Wrong ‚Äî red */

    .log {
      background: #212529;
      color: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      font-family: monospace;
      min-height: 80px;
      max-height: 120px;
      overflow-y: auto;
      margin-top: 10px;
      white-space: pre-wrap;
    }
    .result-area {
      margin-top: 15px;
      text-align: center;
    }
    .result {
      font-size: 1.2em;
      font-weight: bold;
      min-height: 1.6em;
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 12px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { color: #6c757d; font-style: italic; margin-top: 8px; }

    @media (max-width: 480px) {
      .cell {
        width: 56px;
        height: 56px;
        font-size: 18px;
      }
      .grid-container {
        gap: 1px;
        padding: 6px;
      }
    }
  </style>
</head>
<body>
  <h1>üêù Fly Game</h1>
  <p class="subtitle">Listen. Remember. Click.</p>

  <div class="section" id="setup">
    <label for="gridSize">Choose grid size (2√ó2 to 10√ó10):</label>
    <select id="gridSize"></select>
    <button id="startBtn">Start Game</button>
  </div>

  <div class="section" id="game" style="display:none;">
    <p id="startInfo">The fly starts at a marked cell.</p>
    
    <label>Listen to the moves:</label>
    <button id="playStepsBtn">‚ñ∂Ô∏è Play Steps</button>
    <div class="log" id="log">Steps will appear here...</div>

    <label>Click on the cell where the fly ended:</label>
    <div class="grid-container" id="grid"></div>

    <div class="result-area">
      <div class="result" id="result"></div>
      <button id="newGameBtn" style="display:none;">üîÑ New Game</button>
    </div>
    
    <p class="info">üí° Tip: Use headphones for best experience.</p>
  </div>

  <script>
    let n = 3;
    let startPos = { row: 0, col: 0 };
    let finalPos = { row: 0, col: 0 };
    let gameActive = false;
    const moves = ['up', 'down', 'left', 'right'];
    const dx = { up: -1, down: 1, left: 0, right: 0 };
    const dy = { up: 0, down: 0, left: -1, right: 1 };
    let steps = [];

    const setupEl = document.getElementById('setup');
    const gameEl = document.getElementById('game');
    const gridSizeSel = document.getElementById('gridSize');
    const startBtn = document.getElementById('startBtn');
    const playStepsBtn = document.getElementById('playStepsBtn');
    const newGameBtn = document.getElementById('newGameBtn');
    const resultEl = document.getElementById('result');
    const logEl = document.getElementById('log');
    const gridEl = document.getElementById('grid');
    const startInfoEl = document.getElementById('startInfo');

    // Fill grid selector
    for (let i = 2; i <= 10; i++) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = `${i}√ó${i}`;
      gridSizeSel.appendChild(opt);
    }

    // Render grid with start cell
    function renderGrid() {
      gridEl.innerHTML = '';
      gridEl.style.gridTemplateColumns = `repeat(${n}, 1fr)`;

      for (let row = 0; row < n; row++) {
        for (let col = 0; col < n; col++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.row = row;
          cell.dataset.col = col;

          if (row === startPos.row && col === startPos.col) {
            cell.classList.add('start');
          }

          cell.addEventListener('click', () => {
            if (!gameActive) return;
            document.querySelectorAll('.cell.selected').forEach(el => el.classList.remove('selected'));
            cell.classList.add('selected');
            checkAnswer(row, col);
          });

          gridEl.appendChild(cell);
        }
      }
    }

    // Start a new round (same grid size)
    function startNewRound() {
      // Reset UI
      logEl.innerHTML = '<i>Steps will appear here...</i>';
      resultEl.textContent = '';
      resultEl.className = 'result';
      newGameBtn.style.display = 'none';
      gameActive = false;

      // Random start position
      startPos = {
        row: Math.floor(Math.random() * n),
        col: Math.floor(Math.random() * n)
      };

      // Generate path
      let x = startPos.row;
      let y = startPos.col;
      steps = [];
      const stepsCount = Math.floor(Math.random() * 6) + 3;

      for (let i = 0; i < stepsCount; i++) {
        const validMoves = moves.filter(move => {
          const nx = x + dx[move];
          const ny = y + dy[move];
          return nx >= 0 && nx < n && ny >= 0 && ny < n;
        });
        if (validMoves.length === 0) break;
        const move = validMoves[Math.floor(Math.random() * validMoves.length)];
        x += dx[move];
        y += dy[move];
        steps.push(move);
      }

      finalPos = { row: x, col: y };
      renderGrid();

      startInfoEl.textContent = `The fly starts at the yellow cell.`;
    }

    // Initial game start (with size selection)
    startBtn.addEventListener('click', () => {
      n = parseInt(gridSizeSel.value);
      setupEl.style.display = 'none';
      gameEl.style.display = 'block';
      startNewRound();
    });

    // New Game button (after round ends)
    newGameBtn.addEventListener('click', () => {
      startNewRound();
    });

    // Speech
    function speakStepsSequential(steps, index = 0) {
      if (index >= steps.length) {
        gameActive = true;
        return;
      }

      const step = steps[index];
      const utterance = new SpeechSynthesisUtterance(step);
      utterance.lang = 'en-US';
      utterance.rate = 1.0;

      const voices = speechSynthesis.getVoices();
      const enVoice = voices.find(v => v.lang === 'en-US') || voices.find(v => v.lang.startsWith('en'));
      if (enVoice) utterance.voice = enVoice;

      if (index === 0) logEl.innerHTML = '';
      const div = document.createElement('div');
      div.textContent = `‚Üí ${step}`;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;

      utterance.onend = () => setTimeout(() => speakStepsSequential(steps, index + 1), 300);
      utterance.onerror = () => setTimeout(() => speakStepsSequential(steps, index + 1), 500);

      speechSynthesis.cancel();
      speechSynthesis.speak(utterance);
    }

    playStepsBtn.addEventListener('click', () => {
      if (steps.length === 0) return;
      gameActive = false;
      document.querySelectorAll('.cell').forEach(el => {
        el.classList.remove('selected', 'correct', 'incorrect');
        if (el.dataset.row == startPos.row && el.dataset.col == startPos.col) {
          el.classList.add('start');
        }
      });
      resultEl.textContent = '';
      resultEl.className = 'result';

      if (speechSynthesis.getVoices().length === 0) {
        const check = setInterval(() => {
          if (speechSynthesis.getVoices().length > 0) {
            clearInterval(check);
            speakStepsSequential(steps);
          }
        }, 100);
      } else {
        speakStepsSequential(steps);
      }
    });

    // Check answer
    function checkAnswer(guessRow, guessCol) {
      document.querySelectorAll('.cell').forEach(cell => {
        cell.style.pointerEvents = 'none';
      });

      if (guessRow === finalPos.row && guessCol === finalPos.col) {
        document.querySelector(`.cell[data-row="${guessRow}"][data-col="${guessCol}"]`)
          .classList.add('correct');
        resultEl.textContent = 'üéâ Victory!';
        resultEl.className = 'result success';
        speakOnce("Victory!");
      } else {
        document.querySelector(`.cell[data-row="${guessRow}"][data-col="${guessCol}"]`)
          .classList.add('incorrect');
        document.querySelector(`.cell[data-row="${finalPos.row}"][data-col="${finalPos.col}"]`)
          .classList.add('correct');
        resultEl.textContent = 'üòû Try again!';
        resultEl.className = 'result error';
        speakOnce("Try again.");
      }

      newGameBtn.style.display = 'block';
    }

    function speakOnce(text) {
      if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'en-US';
        speechSynthesis.speak(utter);
      }
    }
  </script>
</body>
</html>
